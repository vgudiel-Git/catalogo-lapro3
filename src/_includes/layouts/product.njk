---
layout: layouts/base.njk
---
<article class="product-detail">
  <div class="product-detail__layout">
    {# Left Column - Images #}
    <div class="product-detail__images">
      {# Galería de imágenes con imagen principal y thumbnails #}
      {% if images and (images | length) > 0 %}
        <div class="product-image-gallery">
          {# Imagen principal #}
          <div class="main-image-container">
            {% set firstImg = images[0] %}
            {% if firstImg.image %}
              <img id="mainImage" class="main-product-image" src="{{ firstImg.image }}" alt="{{ firstImg.alt or (title + ' - Imagen principal') }}">
            {% else %}
              <img id="mainImage" class="main-product-image" src="{{ firstImg }}" alt="{{ title + ' - Imagen principal' }}">
            {% endif %}
            
            {# Badge de oferta solo en la imagen principal #}
            {% set discountPrice = price | calculateDiscountPrice(discount, discountPrice) %}
            {% if discountPrice %}
              {% if discount == 'custom' %}
                <span class="offer-badge">Oferta</span>
              {% else %}
                <span class="offer-badge">Descuento {{ discount }}%</span>
              {% endif %}
            {% endif %}
          </div>
          
          {# Thumbnails - solo si hay más de una imagen #}
          {% if images | length > 1 %}
            <div class="thumbnail-container">
              {% for img in images %}
                <div class="thumbnail-item {{ 'active' if loop.first }}" data-index="{{ loop.index0 }}">
                  {% if img.image %}
                    <img class="thumbnail-image" src="{{ img.image }}" alt="{{ img.alt or (title + ' - Thumbnail ' + loop.index) }}">
                  {% else %}
                    <img class="thumbnail-image" src="{{ img }}" alt="{{ title + ' - Thumbnail ' + loop.index }}">
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>

      {# Imagen única (legacy) #}
      {% elif image %}
        <div class="product-image-gallery">
          <div class="main-image-container">
            <img id="mainImage" class="main-product-image" src="{{ image }}" alt="{{ title }}">
            {% set discountPrice = price | calculateDiscountPrice(discount, discountPrice) %}
            {% if discountPrice %}
              {% if discount == 'custom' %}
                <span class="offer-badge">Oferta</span>
              {% else %}
                <span class="offer-badge">Descuento {{ discount }}%</span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="product-image-gallery">
          <div class="main-image-container">
            <img id="mainImage" class="main-product-image" src="/assets/images/default.jpg" alt="{{ title }}">
            {% set discountPrice = price | calculateDiscountPrice(discount, discountPrice) %}
            {% if discountPrice %}
              {% if discount == 'custom' %}
                <span class="offer-badge">Oferta</span>
              {% else %}
                <span class="offer-badge">Descuento {{ discount }}%</span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    {# Right Column - Product Information #}
    <div class="product-detail__info">
      <h1 class="product-detail__title">{{ title }}</h1>

      {% if price %}
        {% set discountPrice = price | calculateDiscountPrice(discount, discountPrice) %}
        {% if discountPrice %}
          <div class="product-detail__price-container">
            <p class="product-detail__price discount-price">Q{{ discountPrice | formatPrice }}</p>
            <p class="product-detail__price original-price">Q{{ price | formatPrice }}</p>
          </div>
        {% else %}
          <p class="product-detail__price">Q{{ price | formatPrice }}</p>
        {% endif %}
      {% endif %}
      
      {% if category %}
          <p class="product-detail__category">
            {% if category is iterable and category is not string %}
              {# Manejar array de categorías #}
              <span class="category-label">{% if category | length > 1 %}Categorías:{% else %}Categoría:{% endif %}</span>
              {% for cat in category %}
                {% if cat == "ofertas" %}
                  <a href="/#ofertas" class="category-link">{{ cat | getCategoryLabel }}</a>
                {% else %}
                  <a href="/#{{ cat }}" class="category-link">{{ cat | getCategoryLabel }}</a>
                {% endif %}{% if not loop.last %} {% endif %}
              {% endfor %}
            {% else %}
              {# Manejar categoría simple (string) #}
              <span class="category-label">Categoría:</span>
              {% if category == "ofertas" %}
                <a href="/#ofertas" class="category-link">{{ category | getCategoryLabel }}</a>
              {% else %}
                <a href="/#{{ category }}" class="category-link">{{ category | getCategoryLabel }}</a>
              {% endif %}
            {% endif %}
          </p>
        {% endif %}

        <div class="product-detail__content">
          {{ content | safe }}
        </div>

        <p class="product-detail__cta-container">
           <a class="btn-whatsapp" href="https://wa.me/16263941200?text=Hola, me interesa el producto: {{ title }}" target="_blank" rel="noopener">
             <span>Comprar por</span>
             <svg class="whatsapp-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
               <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.371c-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
             </svg>
           </a>
         </p>
       </div>
     </div>
   </article>

<!-- Modal Lightbox para galería de imágenes -->
<div id="lightboxModal" class="lightbox-modal">
  <div class="lightbox-overlay"></div>
  <div class="lightbox-content">
    <button class="lightbox-close" id="lightboxClose">&times;</button>
    
    <!-- Navegación izquierda -->
    <button class="lightbox-nav lightbox-prev" id="lightboxPrev">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <!-- Imagen principal del lightbox -->
    <div class="lightbox-image-container">
      <img id="lightboxImage" class="lightbox-image" src="" alt="">
    </div>
    
    <!-- Navegación derecha -->
    <button class="lightbox-nav lightbox-next" id="lightboxNext">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <!-- Contador de imágenes -->
    <div class="lightbox-counter">
      <span id="lightboxCounter">1 / 1</span>
    </div>
  </div>
</div>

<script>
// Funcionalidad de galería de imágenes y lightbox
document.addEventListener('DOMContentLoaded', function() {
  const thumbnails = document.querySelectorAll('.thumbnail-item');
  const mainImage = document.getElementById('mainImage');
  const lightboxModal = document.getElementById('lightboxModal');
  const lightboxImage = document.getElementById('lightboxImage');
  const lightboxClose = document.getElementById('lightboxClose');
  const lightboxPrev = document.getElementById('lightboxPrev');
  const lightboxNext = document.getElementById('lightboxNext');
  const lightboxCounter = document.getElementById('lightboxCounter');
  const lightboxOverlay = document.querySelector('.lightbox-overlay');
  
  // Array de todas las imágenes disponibles
  let allImages = [];
  let currentImageIndex = 0;
  
  // Recopilar todas las imágenes (principal + thumbnails)
  if (mainImage) {
    allImages.push({
      src: mainImage.src,
      alt: mainImage.alt
    });
  }
  
  thumbnails.forEach(function(thumbnail, index) {
    const img = thumbnail.querySelector('.thumbnail-image');
    if (img && index > 0) { // Saltar el primer thumbnail ya que es la imagen principal
      allImages.push({
        src: img.src,
        alt: img.alt
      });
    }
  });
  
  // Funcionalidad de thumbnails (cambiar imagen principal)
  if (thumbnails.length > 0 && mainImage) {
    thumbnails.forEach(function(thumbnail, index) {
      thumbnail.addEventListener('click', function() {
        // Remover clase active de todos los thumbnails
        thumbnails.forEach(function(thumb) {
          thumb.classList.remove('active');
        });
        
        // Agregar clase active al thumbnail clickeado
        this.classList.add('active');
        
        // Cambiar la imagen principal
        const thumbnailImg = this.querySelector('.thumbnail-image');
        if (thumbnailImg) {
          mainImage.src = thumbnailImg.src;
          mainImage.alt = thumbnailImg.alt.replace('Thumbnail', 'Imagen principal');
          currentImageIndex = index;
        }
      });
    });
  }
  
  // Abrir lightbox al hacer clic en la imagen principal
  if (mainImage && lightboxModal) {
    mainImage.addEventListener('click', function() {
      openLightbox(currentImageIndex);
    });
  }
  
  // Función para abrir el lightbox
  function openLightbox(imageIndex) {
    if (allImages.length === 0) return;
    
    currentImageIndex = imageIndex;
    updateLightboxImage();
    lightboxModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  
  // Función para actualizar la imagen del lightbox
  function updateLightboxImage() {
    if (allImages[currentImageIndex]) {
      lightboxImage.src = allImages[currentImageIndex].src;
      lightboxImage.alt = allImages[currentImageIndex].alt;
      lightboxCounter.textContent = `${currentImageIndex + 1} / ${allImages.length}`;
      
      // Mostrar/ocultar botones de navegación
      lightboxPrev.style.display = allImages.length > 1 ? 'flex' : 'none';
      lightboxNext.style.display = allImages.length > 1 ? 'flex' : 'none';
    }
  }
  
  // Cerrar lightbox
  function closeLightbox() {
    lightboxModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
  
  // Navegación anterior
  function prevImage() {
    currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : allImages.length - 1;
    updateLightboxImage();
  }
  
  // Navegación siguiente
  function nextImage() {
    currentImageIndex = currentImageIndex < allImages.length - 1 ? currentImageIndex + 1 : 0;
    updateLightboxImage();
  }
  
  // Event listeners para el lightbox
  if (lightboxClose) {
    lightboxClose.addEventListener('click', closeLightbox);
  }
  
  if (lightboxOverlay) {
    lightboxOverlay.addEventListener('click', closeLightbox);
  }
  
  if (lightboxPrev) {
    lightboxPrev.addEventListener('click', prevImage);
  }
  
  if (lightboxNext) {
    lightboxNext.addEventListener('click', nextImage);
  }
  
  // Navegación con teclado
  document.addEventListener('keydown', function(e) {
    if (lightboxModal.style.display === 'flex') {
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        prevImage();
      } else if (e.key === 'ArrowRight') {
        nextImage();
      }
    }
  });
});
</script>
